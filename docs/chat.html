<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H40N :: CANAL DE COMUNICAÇÃO</title>

<style>
body {
    margin: 0;
    background: #0a0a0a;
    color: #e5e5e5;
    font-family: monospace;
}

#container {
    display: flex;
    flex-direction: column;
    height: 100vh;
}

/* HEADER */
#header {
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    padding: 10px;
    text-align: center;
    letter-spacing: 1px;
    opacity: 0.85;
}

/* CHAT */
#messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.msg {
    margin-bottom: 6px;
}

.msg span.user {
    color: #04a98b;
}

.msg span.ech0 {
    color: #ff4d4d;
}

.msg span.visitante {
    color: #90a8cdbb;
}

/* INPUT */
#inputArea {
    display: flex;
    border-top: 1px solid #333;
    background: #111;
}

#input {
    flex: 1;
    background: transparent;
    border: none;
    padding: 12px;
    color: #e5e5e5;
    outline: none;
}

/* AUTH OVERLAY */
#auth {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(3px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

#authBox {
    width: 420px;
    background: #0a0a0a;
    border: 1px solid #333;
    border-radius: 10px;
    overflow: hidden;
}

#authHeader {
    background: #1a1a1a;
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #333;
    opacity: .8;
}

#authBody {
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

#authBody input {
    background: #111;
    border: 1px solid #333;
    padding: 10px;
    color: #e5e5e5;
    outline: none;
    border-radius: 6px;
}

#authBody button {
    background: #111;
    border: 1px solid #555;
    padding: 10px;
    color: #e5e5e5;
    cursor: pointer;
    border-radius: 6px;
}

#authBody button.login {
    border-color: #00e676;
    color: #00e676;
}
</style>
</head>

<body>

<div id="container">

    <div id="messages"></div>

    <div id="inputArea">
        <input id="input" placeholder="Digite sua mensagem..." autocomplete="off">
    </div>

</div>

<script type="module">
import { initializeApp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { getDatabase, ref, push, onChildAdded, remove } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";


/* FIREBASE */
const app = initializeApp({
    apiKey: "AIzaSyBF2SS3AannotAsRR8s4wFDlKZfdWnlaNU",
    databaseURL: "https://h40n-terminal-default-rtdb.firebaseio.com"
});
const db = getDatabase(app);
const chatRef = ref(db, "rooms/H40N/messages");

/* STATE */
const params = new URLSearchParams(window.location.search);
let currentUser = params.get("user") || "visitante";
currentUser = currentUser.toUpperCase();
const ADMIN_USERS = ["H40N", "ECH0"];


/* ELEMENTS */
const messages = document.getElementById("messages");
const input = document.getElementById("input");

window.login = () => {
    const u = document.getElementById("user").value.trim().toUpperCase();
    const p = document.getElementById("pass").value.trim();

    if (
        (u === "H40N" && p === "PR4G4#33") ||
        (u === "ECH0" && p === "33#33")
    ) {
        currentUser = u;
        
        auth.style.display = "none";
    }
};

/* SEND */
input.addEventListener("keydown", async e => {
    if (e.key !== "Enter") return;

    const text = input.value.trim();
    if (!text) return;

    // ⛔ INTERCEPTA COMANDOS
    if (text.startsWith("/")) {

        if (text === "/clear") {
            if (!ADMIN_USERS.includes(currentUser)) {
                systemMessage("Permissão negada");
                input.value = "";
                return;
            }

            await remove(chatRef);
            messages.innerHTML = "";
            input.value = "";
            return;
        }

        // comando desconhecido
        systemMessage("Comando desconhecido");
        input.value = "";
        return;
    }

    // ✅ APENAS MENSAGENS REAIS CHEGAM AQUI
    push(chatRef, {
        user: currentUser,
        text,
        time: Date.now()
    });

    input.value = "";
});


/* RECEIVE */
onChildAdded(chatRef, snap => {
    const { user, text } = snap.val();

    const div = document.createElement("div");
    div.className = "msg";

    let cls = "visitante";
    if (user === "H40N") cls = "user";
    if (user === "ECH0") cls = "ech0";

    div.innerHTML = `<span class="${cls}">${user}</span> > ${text}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
});

function systemMessage(text) {
    const div = document.createElement("div");
    div.className = "msg";
    div.style.opacity = "0.6";
    div.innerHTML = `<span style="color:#ffe100">SYSTEM</span> > ${text}`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

</script>

</body>
</html>
